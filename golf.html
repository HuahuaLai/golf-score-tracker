<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>高爾夫桿數紀錄器</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">

    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // 將 Firebase 模組掛載到 window 物件上，以便在 <script type="text/babel"> 中存取
        window.firebase = { initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, getFirestore, doc, setDoc, onSnapshot };

        // 手動定義 Lucide React 圖示，因為直接在瀏覽器中載入模組較複雜
        window.lucide = window.lucide || {};
        window.lucide.ChevronLeft = (props) => (
            React.createElement('svg', { ...props, xmlns: "http://www.w3.org/2000/svg", width: props.size || 24, height: props.size || 24, viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2", strokeLinecap: "round", strokeLinejoin: "round" },
                React.createElement('path', { d: "m15 18-6-6 6-6" })
            )
        );
        window.lucide.ChevronRight = (props) => (
            React.createElement('svg', { ...props, xmlns: "http://www.w3.org/2000/svg", width: props.size || 24, height: props.size || 24, viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2", strokeLinecap: "round", strokeLinejoin: "round" },
                React.createElement('path', { d: "m9 18 6-6-6-6" })
            )
        );
    </script>

    <script>
        const __app_id = typeof window.__app_id !== 'undefined' ? window.__app_id : 'default-golf-app';

        // Firebase 設定已替換為您提供的值
        const __firebase_config = typeof window.__firebase_config !== 'undefined' ? window.__firebase_config : JSON.stringify({
            apiKey: "AIzaSyBUIKGWWiKoRKk_EEiAhGkSboI0AzeCkYY",
            authDomain: "golf-aabb6.firebaseapp.com",
            projectId: "golf-aabb6",
            storageBucket: "golf-aabb6.firebasestorage.app",
            messagingSenderId: "934119452469",
            appId: "1:934119452469:web:4bb7f8ff6698c3b6a6667c",
            measurementId: "G-M8C1K9EE3Q"
        });

        const __initial_auth_token = typeof window.__initial_auth_token !== 'undefined' ? window.__initial_auth_token : null;
    </script>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        // React 應用程式的程式碼從這裡開始
        const { useState, useEffect, useRef } = React;

        // 從 window.lucide 取得圖示組件
        const ChevronLeft = window.lucide.ChevronLeft;
        const ChevronRight = window.lucide.ChevronRight;

        // Firebase 相關的引入
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id'; // 使用全域 app_id
        const firebaseConfig = JSON.parse(__firebase_config); // 解析全域 firebase_config
        const initialAuthToken = __initial_auth_token; // 使用全域 initial_auth_token

        // 從 window.firebase 取得 Firebase 函式
        const { initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, getFirestore, doc, setDoc, onSnapshot } = window.firebase || {};

        // 確認 Modal 組件
        const ConfirmationModal = ({ message, onConfirm, onCancel }) => {
          return (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
              <div className="bg-white rounded-lg shadow-xl p-6 max-w-sm w-full text-center">
                <p className="text-lg font-semibold mb-6">{message}</p>
                <div className="flex justify-around gap-4">
                  <button
                    onClick={onConfirm}
                    className="bg-red-700 hover:bg-red-800 text-white font-bold py-2 px-5 rounded-lg shadow-md
                               transition duration-200 ease-in-out transform hover:scale-105 active:scale-95 flex-grow"
                  >
                    確認
                  </button>
                  <button
                    onClick={onCancel}
                    className="bg-gray-400 hover:bg-gray-500 text-gray-800 font-bold py-2 px-5 rounded-lg shadow-md
                               transition duration-200 ease-in-out transform hover:scale-105 active:scale-95 flex-grow"
                  >
                    取消
                  </button>
                </div>
              </div>
            </div>
          );
        };

        // 主要 App 組件
        const App = () => {
          // Firebase 和使用者認證的狀態
          const [db, setDb] = useState(null);
          const [auth, setAuth] = useState(null);
          const [userId, setUserId] = useState(null);
          const [isAuthReady, setIsAuthReady] = useState(false); // 追蹤認證狀態是否已確定
          const [isLoading, setIsLoading] = useState(true); // 資料載入狀態

          // 儲存18洞桿數的狀態，初始化為0
          const [holeScores, setHoleScores] = useState(Array(18).fill(0));
          // 追蹤目前球洞的狀態 (索引 0 到 17)
          const [currentHoleIndex, setCurrentHoleIndex] = useState(0);
          // 儲存總桿數的狀態
          const [totalScore, setTotalScore] = useState(0);
          // 確認清除 Modal 的可見性狀態
          const [showClearConfirm, setShowClearConfirm] = useState(false);
          // 最近更新球洞的暫時視覺回饋狀態
          const [lastUpdatedHole, setLastUpdatedHole] = useState(null);

          // Firestore 寫入的 debounce 計時器 ref
          const saveTimeoutRef = useRef(null);

          // --- Firebase 初始化和認證 ---
          useEffect(() => {
            if (!initializeApp || !getAuth || !getFirestore) {
              console.error("Firebase SDK 未載入。請確認已包含 Firebase CDN 指令碼。");
              setIsLoading(false);
              return;
            }

            try {
              // 檢查 firebaseConfig 是否為空物件或缺少 projectId
              if (!firebaseConfig || Object.keys(firebaseConfig).length === 0 || !firebaseConfig.projectId) {
                console.warn("Firebase 設定不完整或未提供。應用程式將在沒有後端儲存的情況下運行。");
                setIsLoading(false);
                setIsAuthReady(true); // 標記認證已「準備好」（即使沒有 Firebase）以允許 UI 渲染
                setUserId(crypto.randomUUID()); // 提供一個本地隨機 ID
                return;
              }

              const app = initializeApp(firebaseConfig);
              const firestore = getFirestore(app);
              const authInstance = getAuth(app);

              setDb(firestore);
              setAuth(authInstance);
              console.log("Firebase App initialized with Project ID:", firebaseConfig.projectId);


              const unsubscribe = onAuthStateChanged(authInstance, async (user) => {
                if (user) {
                  setUserId(user.uid);
                  console.log("User signed in with UID:", user.uid);
                } else {
                  try {
                    if (initialAuthToken) {
                      console.log("Attempting sign in with custom token.");
                      await signInWithCustomToken(authInstance, initialAuthToken);
                    } else {
                      console.log("Attempting anonymous sign in.");
                      await signInAnonymously(authInstance);
                    }
                    const currentAuthUser = authInstance.currentUser;
                    if (currentAuthUser) {
                        setUserId(currentAuthUser.uid);
                        console.log("User signed in anonymously/custom token with UID:", currentAuthUser.uid);
                    } else {
                        console.warn("Anonymous/Custom token sign-in did not result in a user.");
                        setUserId(crypto.randomUUID()); // Fallback
                    }
                  } catch (error) {
                    console.error("Firebase 認證失敗:", error);
                    setUserId(crypto.randomUUID()); // 若認證失敗則使用隨機 ID
                  }
                }
                setIsAuthReady(true); // 認證狀態已確定
              });

              return () => unsubscribe(); // 清理認證監聽器
            } catch (error) {
              console.error("初始化 Firebase 時發生錯誤:", error);
              setIsLoading(false);
              setIsAuthReady(true); // 即使出錯也標記為準備好，以避免無限載入
              setUserId(crypto.randomUUID()); // 提供一個本地隨機 ID
            }
          }, []); // 只在組件掛載時執行一次

          // --- Firestore 資料載入 (onSnapshot) ---
          useEffect(() => {
            if (db && userId && isAuthReady) {
              console.log(`Setting up Firestore listener for user: ${userId}, app: ${appId}`);
              const userDocRef = doc(db, `artifacts/${appId}/users/${userId}/golfScores`, 'currentRound');
              const unsubscribe = onSnapshot(userDocRef, (docSnap) => {
                if (docSnap.exists()) {
                  const data = docSnap.data();
                  console.log("Firestore data received:", data);
                  if (data && Array.isArray(data.scores) && data.scores.length === 18) {
                    setHoleScores(data.scores);
                    setCurrentHoleIndex(typeof data.currentHoleIndex === 'number' ? data.currentHoleIndex : 0);
                  } else {
                    console.warn("Firestore data is malformed or scores array is not length 18. Resetting to default.");
                    setHoleScores(Array(18).fill(0));
                    setCurrentHoleIndex(0);
                  }
                } else {
                  console.log("Firestore document does not exist. Initializing with default scores.");
                  setDoc(userDocRef, { scores: Array(18).fill(0), currentHoleIndex: 0 }, { merge: true })
                    .catch(error => console.error("初始化文件時發生錯誤:", error));
                }
                setIsLoading(false); // 資料已載入或初始化
              }, (error) => {
                console.error("從 Firestore 獲取文件時發生錯誤:", error);
                setIsLoading(false);
              });

              return () => {
                console.log("Cleaning up Firestore listener.");
                unsubscribe(); // 清理快照監聽器
              }
            } else if (isAuthReady && !userId && !db) { // 如果 Firebase 未初始化但認證已「準備好」
                console.log("Firebase not initialized, using local state only.");
                setIsLoading(false); // 停止載入
            } else if (isAuthReady && !userId && db) { // 如果 Firebase 已初始化但 userId 為空
                console.warn("Auth is ready, but no userId. Cannot fetch/save data.");
                setIsLoading(false);
            }
          }, [db, userId, isAuthReady, appId]); // 當 db, userId, isAuthReady 或 appId 改變時重新執行

          // --- Firestore 資料儲存 (帶 debounce) ---
          useEffect(() => {
            // 只有在 Firebase 初始化、有 userId、認證完成且初始載入完成後才儲存
            if (db && userId && isAuthReady && !isLoading) {
              if (saveTimeoutRef.current) {
                clearTimeout(saveTimeoutRef.current);
              }
              saveTimeoutRef.current = setTimeout(() => {
                console.log(`Saving scores to Firestore for user: ${userId}, app: ${appId}`);
                const userDocRef = doc(db, `artifacts/${appId}/users/${userId}/golfScores`, 'currentRound');
                setDoc(userDocRef, { scores: holeScores, currentHoleIndex: currentHoleIndex }, { merge: true })
                  .then(() => console.log("Scores saved successfully."))
                  .catch(error => console.error("儲存分數到 Firestore 時發生錯誤:", error));
              }, 500); // Debounce 500ms
            }
          }, [holeScores, currentHoleIndex, db, userId, isAuthReady, isLoading, appId]); // 當分數或目前球洞改變時重新執行

          // 當 holeScores 改變時重新計算總桿數的 Effect
          useEffect(() => {
            const sum = holeScores.reduce((acc, score) => acc + score, 0);
            setTotalScore(sum);
          }, [holeScores]);

          // 處理數字按鈕點擊的函式
          const handleNumberClick = (num) => {
            const newScores = [...holeScores];
            newScores[currentHoleIndex] = num;
            setHoleScores(newScores);

            // 視覺回饋
            setLastUpdatedHole(currentHoleIndex);
            setTimeout(() => setLastUpdatedHole(null), 300); // 300ms 後移除高亮

            // 如果不是最後一洞，則移至下一洞
            if (currentHoleIndex < 17) {
              setCurrentHoleIndex(currentHoleIndex + 1);
            }
          };

          // 處理 +1 按鈕點擊的函式
          const handlePlusOne = () => {
            const newScores = [...holeScores];
            newScores[currentHoleIndex] = (newScores[currentHoleIndex] || 0) + 1; // 確保是數字
            setHoleScores(newScores);

            // 視覺回饋
            setLastUpdatedHole(currentHoleIndex);
            setTimeout(() => setLastUpdatedHole(null), 300);
          };

          // 處理 -1 按鈕點擊的函式
          const handleMinusOne = () => {
            const newScores = [...holeScores];
            // 如果目前分數是0，則保持0，否則減1但不低於1。
            // 如果目前分數是0，則保持0，否則減1。若桿數為1，再減1則變為0。
            newScores[currentHoleIndex] = newScores[currentHoleIndex] > 0 ? newScores[currentHoleIndex] - 1 : 0;
            setHoleScores(newScores);

            // 視覺回饋
            setLastUpdatedHole(currentHoleIndex);
            setTimeout(() => setLastUpdatedHole(null), 300);
          };

          // 初始化清除動作的函式 (顯示確認 Modal)
          const handleClearInitiate = () => {
            setShowClearConfirm(true);
          };

          // 確認清除動作的函式
          const handleClearConfirm = () => {
            setHoleScores(Array(18).fill(0));
            setCurrentHoleIndex(0); // 重設回第一洞
            setShowClearConfirm(false); // 隱藏 Modal
          };

          // 取消清除動作的函式
          const handleClearCancel = () => {
            setShowClearConfirm(false); // 隱藏 Modal
          };

          // 導覽至前一洞的函式
          const handlePrevHole = () => {
            setCurrentHoleIndex(prevIndex => Math.max(0, prevIndex - 1));
          };

          // 導覽至後一洞的函式
          const handleNextHole = () => {
            setCurrentHoleIndex(prevIndex => Math.min(17, prevIndex + 1));
          };

          // 顯示球洞格線的組件
          const HoleGrid = () => (
            <div className="grid grid-cols-10 gap-1 p-2 bg-neutral-200 rounded-lg shadow-inner w-full max-w-md mx-auto">
              {/* 1-9 洞的標頭列 */}
              {Array.from({ length: 9 }, (_, i) => i + 1).map(holeNum => (
                <div key={`header-${holeNum}`} className="text-center text-xs font-semibold text-neutral-600 p-1">
                  {holeNum}
                </div>
              ))}
              {/* 用於對齊的空格 */}
              <div className="col-span-1"></div>

              {/* 1-9 洞的分數 */}
              {holeScores.slice(0, 9).map((score, index) => (
                <div
                  key={`score-${index}`}
                  className={`col-span-1 flex items-center justify-center p-2 border border-neutral-300 rounded-md text-sm font-bold transition-all duration-150 ease-in-out cursor-pointer
                    ${index === currentHoleIndex ? 'bg-amber-200 border-amber-400 shadow-md ring-2 ring-amber-500' : 'bg-white hover:bg-neutral-50'}
                    ${index === lastUpdatedHole ? 'bg-emerald-200 border-emerald-400 animate-pulse' : ''}
                  `}
                  onClick={() => setCurrentHoleIndex(index)} // 允許點擊球洞以選擇
                >
                  {score === 0 ? '' : score}
                </div>
              ))}
              {/* 1-9 洞的總計 */}
              <div className="col-span-1 flex items-center justify-center p-2 border border-neutral-300 rounded-md bg-sky-100 text-sm font-bold">
                {holeScores.slice(0, 9).reduce((acc, s) => acc + s, 0)}
              </div>

              {/* 10-18 洞的標頭列 */}
              {Array.from({ length: 9 }, (_, i) => i + 10).map(holeNum => (
                <div key={`header-${holeNum}`} className="text-center text-xs font-semibold text-neutral-600 p-1">
                  {holeNum}
                </div>
              ))}
              {/* 用於對齊的空格 */}
              <div className="col-span-1"></div>

              {/* 10-18 洞的分數 */}
              {holeScores.slice(9, 18).map((score, index) => (
                <div
                  key={`score-${index + 9}`}
                  className={`col-span-1 flex items-center justify-center p-2 border border-neutral-300 rounded-md text-sm font-bold transition-all duration-150 ease-in-out cursor-pointer
                    ${(index + 9) === currentHoleIndex ? 'bg-amber-200 border-amber-400 shadow-md ring-2 ring-amber-500' : 'bg-white hover:bg-neutral-50'}
                    ${(index + 9) === lastUpdatedHole ? 'bg-emerald-200 border-emerald-400 animate-pulse' : ''}
                  `}
                  onClick={() => setCurrentHoleIndex(index + 9)} // 允許點擊球洞以選擇
                >
                  {score === 0 ? '' : score}
                </div>
              ))}
              {/* 10-18 洞的總計 */}
              <div className="col-span-1 flex items-center justify-center p-2 border border-neutral-300 rounded-md bg-sky-100 text-sm font-bold">
                {holeScores.slice(9, 18).reduce((acc, s) => acc + s, 0)}
              </div>
            </div>
          );

          // 數字輸入板 (1-15)
          const NumberInputPad = ({ handleNumberClick }) => (
            <div className="grid grid-cols-5 gap-2 p-4 bg-neutral-200 rounded-lg shadow-inner w-full max-w-md mx-auto mt-4">
              {[1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15].map(num => (
                <button
                  key={num}
                  onClick={() => handleNumberClick(num)}
                  className="bg-neutral-700 hover:bg-neutral-800 text-white font-bold py-3 sm:py-4 rounded-lg shadow-md text-lg sm:text-2xl
                             transition duration-200 ease-in-out transform hover:scale-105 active:scale-95"
                >
                  {num}
                </button>
              ))}
            </div>
          );

          // 導覽和調整按鈕組件
          const NavAdjustButtons = ({ handlePrevHole, handlePlusOne, handleMinusOne, handleNextHole }) => (
            <div className="flex justify-center items-center gap-2 p-2 w-full max-w-md mx-auto mt-2">
              <button
                onClick={handlePrevHole}
                disabled={currentHoleIndex === 0}
                className="bg-neutral-500 hover:bg-neutral-600 text-white font-bold py-3 px-4 rounded-lg shadow-md text-lg
                           transition duration-200 ease-in-out transform hover:scale-105 active:scale-95 flex-grow disabled:opacity-50 disabled:cursor-not-allowed"
              >
                <ChevronLeft size={24} />
              </button>
              <button
                onClick={handleMinusOne}
                className="bg-emerald-700 hover:bg-emerald-800 text-white font-bold py-3 px-6 rounded-lg shadow-md text-lg
                           transition duration-200 ease-in-out transform hover:scale-105 active:scale-95 flex-grow"
              >
                - 1
              </button>
              <button
                onClick={handlePlusOne}
                className="bg-red-700 hover:bg-red-800 text-white font-bold py-3 px-6 rounded-lg shadow-md text-lg
                           transition duration-200 ease-in-out transform hover:scale-105 active:scale-95 flex-grow"
              >
                + 1
              </button>
              <button
                onClick={handleNextHole}
                disabled={currentHoleIndex === 17}
                className="bg-neutral-500 hover:bg-neutral-600 text-white font-bold py-3 px-4 rounded-lg shadow-md text-lg
                           transition duration-200 ease-in-out transform hover:scale-105 active:scale-95 flex-grow disabled:opacity-50 disabled:cursor-not-allowed"
              >
                <ChevronRight size={24} />
              </button>
            </div>
          );

          if (isLoading && (!firebaseConfig || Object.keys(firebaseConfig).length === 0 || !firebaseConfig.projectId)) {
             // 若 Firebase 設定為空且仍在載入，顯示特定訊息或允許無後端使用
          } else if (isLoading) {
            return (
              <div className="min-h-screen bg-gradient-to-br from-neutral-100 to-neutral-300 flex flex-col items-center justify-center p-4 font-inter text-neutral-800">
                <svg className="animate-spin h-10 w-10 text-neutral-600 mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                  <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                  <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <p className="text-2xl">載入中...</p>
                <p className="text-sm mt-2">正在同步您的桿數紀錄</p>
              </div>
            );
          }

          return (
            <div className="min-h-screen bg-gradient-to-br from-neutral-100 to-neutral-300 flex flex-col items-center justify-start p-4 font-inter overflow-auto selection:bg-amber-500 selection:text-white">
              {/* 總桿數和目前球洞顯示 */}
              <div className="flex flex-col sm:flex-row justify-between items-center bg-neutral-700 text-white font-bold py-3 px-6 rounded-lg shadow-xl text-lg w-full max-w-md mx-auto mb-4 sticky top-4 z-10">
                <div className="flex items-center justify-center w-full sm:w-auto mb-2 sm:mb-0">
                  總桿數 <span className="ml-3 text-3xl font-mono">{totalScore}</span>
                </div>
                <div className="flex items-center justify-center w-full sm:w-auto">
                  目前球洞: <span className="ml-2 text-sky-300 text-3xl font-mono">{currentHoleIndex + 1}</span>
                </div>
              </div>

              <HoleGrid />
              <NumberInputPad handleNumberClick={handleNumberClick} />
              <NavAdjustButtons
                handlePrevHole={handlePrevHole}
                handlePlusOne={handlePlusOne}
                handleMinusOne={handleMinusOne}
                handleNextHole={handleNextHole}
              />

              <button
                onClick={handleClearInitiate}
                className="bg-red-700 hover:bg-red-800 text-white font-bold py-3 px-6 rounded-lg shadow-md text-lg mt-4 w-full max-w-md
                           transition duration-200 ease-in-out transform hover:scale-105 active:scale-95"
              >
                清除所有紀錄
              </button>

              {/* 顯示用戶 ID */}
              {userId && (
                <div className="mt-6 text-xs text-neutral-500 text-center px-2">
                  用戶ID (用於同步): <span className="font-mono text-neutral-700 break-all block sm:inline">{userId}</span>
                </div>
              )}
               {(!firebaseConfig || Object.keys(firebaseConfig).length === 0 || !firebaseConfig.projectId) && !isLoading && (
                <div className="mt-4 p-3 bg-yellow-100 border border-yellow-400 text-yellow-700 rounded-md text-sm max-w-md w-full text-center">
                  注意：Firebase 未設定。您的分數將不會被儲存到雲端。
                </div>
              )}


              {/* 確認 Modal */}
              {showClearConfirm && (
                <ConfirmationModal
                  message="您確定要清除所有桿數嗎？此操作無法復原。"
                  onConfirm={handleClearConfirm}
                  onCancel={handleClearCancel}
                />
              )}
            </div>
          );
        };

        // 將 React 應用程式渲染到 HTML 頁面中的 'root' 元素
        ReactDOM.createRoot(document.getElementById('root')).render(React.createElement(App));
        // React 應用程式的程式碼在這裡結束
    </script>
</body>
</html>
